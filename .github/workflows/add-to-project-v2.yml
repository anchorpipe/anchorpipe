name: Add to Project V2

on:
  issues:
    types: [opened, reopened, labeled]
  pull_request:
    types: [opened, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    # Skip if issue/PR is created by automation (bot label)
    if: |
      (github.event_name == 'issues' && !contains(github.event.issue.labels.*.name, 'bot')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'bot'))
    env:
      PROJECT_V2_URL: ${{ secrets.PROJECT_V2_URL }}
      PROJECT_V2_TOKEN: ${{ secrets.PROJECT_V2_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Project V2 configuration
        if: env.PROJECT_V2_URL == '' || env.PROJECT_V2_TOKEN == ''
        run: |
          echo "⚠️  WARNING: Missing Project V2 configuration."
          if [ -z "$PROJECT_V2_URL" ]; then echo "- PROJECT_V2_URL is not set"; fi
          if [ -z "$PROJECT_V2_TOKEN" ]; then echo "- PROJECT_V2_TOKEN is not set (PAT with access to org Projects v2)"; fi
          echo "Skipping adding to Project V2."
          echo "Expected URL: https://github.com/orgs/anchorpipe/projects/NUMBER"

      - name: Add issue/PR to Project V2
        if: env.PROJECT_V2_URL != '' && env.PROJECT_V2_TOKEN != ''
        uses: actions/add-to-project@v0.6.1
        with:
          # Project URL for organization project
          # Format: https://github.com/orgs/ORG_NAME/projects/PROJECT_NUMBER
          project-url: ${{ secrets.PROJECT_V2_URL }}
          github-token: ${{ secrets.PROJECT_V2_TOKEN }}
          # Organization projects require owner field
          owner: anchorpipe
          # Repository name
          repository: ${{ github.repository }}

      - name: Add triage label for new issues
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            if (!labels.some(l => l.startsWith('status:'))) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['status:needs-triage']
              });
            }
