name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate PR requirements
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Checking PR requirements..."

          # Load PR metadata safely from event payload (avoid shell injection)
          PR_BODY="$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"

          if ! echo "$PR_BODY" | grep -qE "(#\d+|closes|fixes|resolves)"; then
            echo "⚠️  PR should link to an issue (use #issue-number, closes #issue, or fixes #issue)"
            echo "This is a warning, not a blocker."
          fi

          # Check that PR title follows Conventional Commits (optional but recommended)
          if ! echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?:"; then
            echo "⚠️  PR title should follow Conventional Commits format"
            echo "Example: feat(web): add user authentication"
            echo "This is a warning, not a blocker."
          fi

          # Enforce docs for feature PRs
          echo "Checking documentation expectations for feature PRs..."
          PR_LABELS="$(jq -r '.pull_request.labels[].name // empty' "$GITHUB_EVENT_PATH")"
          if echo "$PR_LABELS" | grep -qx 'type:feature'; then
            BASE_SHA="$(jq -r '.pull_request.base.sha' "$GITHUB_EVENT_PATH")"
            CHANGED_FILES="$(git diff --name-only "$BASE_SHA"...HEAD || true)"

            DOCS_CHANGED="$(echo "$CHANGED_FILES" | grep -E '^(apps/docs/docs/|docs/|adr/)' || true)"

            if [ -z "$DOCS_CHANGED" ]; then
              echo "❌ This PR is labeled 'type:feature' but no documentation files were changed."
              echo "Expected updates in one or more of:"
              echo "  - apps/docs/docs/** or docs/** (user / reference docs)"
              echo "  - apps/docs/docs/api/** or OpenAPI (API docs)"
              echo "  - adr/** or apps/docs/docs/reference/adr/** (architecture decisions)"
              echo ""
              echo "If docs are truly not required, either:"
              echo "  - Add a short explanation under 'Documentation Checklist' in the PR body, OR"
              echo "  - Adjust labels if this is not a feature change."
              echo ""
              echo "See documentation standards at: apps/docs/docs/contributing/documentation-standards.md"
              exit 1
            else
              echo "✅ Feature PR includes documentation changes:"
              echo "$DOCS_CHANGED"
            fi
          else
            echo "Skipping docs-enforcement: PR is not labeled type:feature."
          fi

          echo "✅ PR validation checks complete"

      - name: Check branch name
        shell: bash
        env:
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # Check branch naming convention using grep (POSIX-compatible)
          if echo "$BRANCH_NAME" | grep -Eq '^(feat|fix|docs|chore|refactor|perf|test|ci|build)/.+'; then
            echo "✅ Branch name follows convention"
          else
            echo "⚠️  Branch name doesn't follow convention (feat/fix/docs/chore/refactor/perf/test/ci/build)/description"
            echo "Current branch: $BRANCH_NAME"
            echo "This is a warning, not a blocker."
          fi

      - name: Check for large files
        shell: bash
        run: |
          echo "Checking for large files..."
          LARGE_FILES=$(find . -type f -size +1M ! -path './.git/*' ! -path './node_modules/*' ! -path './.next/*' ! -path './coverage/*' ! -path './dist/*' 2>/dev/null | head -10)

          if [ -n "$LARGE_FILES" ]; then
            echo "⚠️  Large files detected (>1MB):"
            echo "$LARGE_FILES"
            echo "Consider using Git LFS for large files or excluding them from the repo."
          else
            echo "✅ No large files detected"
          fi
