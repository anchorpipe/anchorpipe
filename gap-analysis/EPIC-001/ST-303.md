# Gap Analysis: ST-303 - Implement Webhook Ingestion Endpoint

**Story**: ST-303  
**Epic**: EPIC-001 (Core Platform)  
**Status**: ⚠️ Partially Implemented  
**Date**: 2025-11-09

## Summary

ST-303 implements the webhook ingestion endpoint for receiving test data from CI systems. The endpoint exists with HMAC authentication and rate limiting, but core processing functionality is missing.

## Requirements Analysis

### Acceptance Criteria

| Criteria | Status | Notes |
|----------|--------|-------|
| HMAC signature validation | ✅ Complete | `authenticateHmacRequest` implemented |
| Payload schema validation | ❌ Not Implemented | No schema validation |
| Rate limiting | ✅ Complete | Rate limiting with violation logging |
| Queue events for processing | ❌ Not Implemented | TODO in code |
| Duplicate detection/handling | ❌ Not Implemented | Idempotency TODO (ST-307) |
| Event logging | ⚠️ Partial | Audit logs for rate limits, but not ingestion events |
| Error handling | ⚠️ Partial | Basic error handling, needs improvement |

### Non-Functional Requirements

| Requirement | Status | Notes |
|-------------|--------|-------|
| Security (HMAC validation) | ✅ Complete | HMAC authentication implemented |
| Observability (event logging) | ⚠️ Partial | Rate limit logging exists, ingestion events not logged |
| Testability | ❌ Not Implemented | No unit/integration tests |
| Documentation | ⚠️ Partial | Basic endpoint exists, format not documented |
| Performance | ✅ Complete | Payload size limits, rate limiting |
| Reliability | ⚠️ Partial | No queue integration, no retry logic |

## Implementation Status

### ✅ Implemented

1. **Endpoint Structure** (`apps/web/src/app/api/ingestion/route.ts`)
   - ✅ POST `/api/ingestion` endpoint exists
   - ✅ HMAC authentication (`authenticateHmacRequest`)
   - ✅ Rate limiting with violation logging
   - ✅ Payload size validation (50MB limit)
   - ✅ Basic error handling

2. **Security**
   - ✅ HMAC signature validation
   - ✅ Rate limiting
   - ✅ Payload size limits

### ❌ Gaps Identified

#### Critical Gaps

1. **Payload Schema Validation**
   - **Status**: Not implemented
   - **Impact**: High (invalid payloads accepted)
   - **Recommendation**: Add Zod schema validation for ingestion payload
   - **Effort**: Small (1-2 hours)

2. **Message Queue Integration**
   - **Status**: Not implemented (TODO in code)
   - **Impact**: High (events not queued for processing)
   - **Recommendation**: Publish events to RabbitMQ `test.ingestion` queue
   - **Effort**: Small (2-3 hours)
   - **Dependencies**: ST-319 (Message Queue Integration) - but infrastructure exists

3. **Database Storage**
   - **Status**: Not implemented (TODO in code)
   - **Impact**: High (no metadata stored)
   - **Recommendation**: Store ingestion events in database (TelemetryEvent or new model)
   - **Effort**: Small (1-2 hours)

#### High Priority Gaps

4. **Idempotency Validation**
   - **Status**: Not implemented (TODO in code)
   - **Impact**: Medium (duplicate events possible)
   - **Recommendation**: Implement idempotency check (repo_id, commit_sha, run_id, framework)
   - **Effort**: Medium (2-3 hours)
   - **Dependencies**: ST-307 (Idempotency for Ingestion API) - but can implement basic version

5. **Event Logging**
   - **Status**: Partial (rate limits logged, ingestion events not)
   - **Impact**: Medium (no audit trail for ingestion)
   - **Recommendation**: Add audit logging for successful/failed ingestion
   - **Effort**: Small (1 hour)

#### Medium Priority Gaps

6. **Test Report Parsing**
   - **Status**: Not implemented (TODO in code)
   - **Impact**: Low (parsing is ST-304)
   - **Recommendation**: Defer to ST-304
   - **Effort**: Large (deferred)

7. **Object Storage Integration**
   - **Status**: Not implemented (TODO in code)
   - **Impact**: Low (large artifacts not handled)
   - **Recommendation**: Defer to ST-320
   - **Effort**: Medium (deferred)

8. **Unit/Integration Tests**
   - **Status**: Not implemented
   - **Impact**: Medium (no test coverage)
   - **Recommendation**: Add comprehensive tests
   - **Effort**: Medium (2-3 hours)

9. **Documentation**
   - **Status**: Partial (endpoint exists, format not documented)
   - **Impact**: Medium (users don't know payload format)
   - **Recommendation**: Document webhook payload format and authentication
   - **Effort**: Small (1-2 hours)

## Recommended Implementation Order

### Phase 1: Critical Gaps (Must Complete)

1. **Payload Schema Validation** (1-2 hours)
   - Add Zod schema for ingestion payload
   - Validate required fields (repo_id, commit_sha, run_id, framework, payload)
   - Return appropriate error codes

2. **Message Queue Integration** (2-3 hours)
   - Integrate RabbitMQ via `@anchorpipe/mq`
   - Publish events to `test.ingestion` queue
   - Handle connection errors gracefully

3. **Database Storage** (1-2 hours)
   - Store ingestion metadata in `TelemetryEvent` table
   - Track ingestion status and metadata
   - Add indexes for querying

### Phase 2: High Priority Gaps (Should Complete)

4. **Idempotency Validation** (2-3 hours)
   - Check for duplicate events (repo_id, commit_sha, run_id, framework)
   - Return appropriate response for duplicates
   - Store idempotency keys

5. **Event Logging** (1 hour)
   - Add audit logging for ingestion events
   - Log success/failure with metadata
   - Track ingestion metrics

### Phase 3: Medium Priority Gaps (Nice to Have)

6. **Unit/Integration Tests** (2-3 hours)
   - Test HMAC validation
   - Test payload validation
   - Test queue integration
   - Test error handling

7. **Documentation** (1-2 hours)
   - Document webhook payload format
   - Document authentication requirements
   - Add examples

## Files to Create

- `apps/web/src/lib/server/ingestion-service.ts` - Ingestion service logic
- `apps/web/src/lib/server/__tests__/ingestion-service.test.ts` - Unit tests
- `apps/web/src/lib/server/ingestion-schema.ts` - Zod schemas for validation

## Files to Modify

- `apps/web/src/app/api/ingestion/route.ts` - Complete implementation
- `docs/guides/integrations/ci-integration.md` - Update documentation

## Dependencies

- ✅ ST-105: API Gateway / BFF (complete)
- ✅ ST-208: HMAC Authentication (complete)
- ✅ ST-106: Message Queue (RabbitMQ infrastructure exists)
- ⚠️ ST-319: Message Queue Integration (infrastructure exists, integration needed)
- ⚠️ ST-307: Idempotency (can implement basic version)
- ⚠️ ST-304: Test Report Parsers (deferred)

## Conclusion

ST-303 is **partially implemented** with security and basic validation in place, but core processing functionality (queue integration, database storage, payload validation) is missing. Critical gaps should be addressed to make the endpoint functional.

**Overall Status**: ⚠️ **~40% Complete**

**Next Steps**: Implement Phase 1 critical gaps (payload validation, queue integration, database storage).

