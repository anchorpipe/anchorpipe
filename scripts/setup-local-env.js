#!/usr/bin/env node

/**
 * Setup Local Environment Script
 *
 * Generates required environment variables for local testing.
 *
 * Usage:
 *   node scripts/setup-local-env.js
 */

const crypto = require('crypto');
const fs = require('fs');
const path = require('path');

const envPath = path.join(__dirname, '..', '.env.local');
const tempPath = envPath + '.tmp';

// Generate encryption key
const encryptionKey = crypto.randomBytes(32).toString('base64');

// Default environment variables
const envContent = `# Local Development Environment Variables
# Generated by setup-local-env.js

# Database
DATABASE_URL="postgresql://postgres:postgres@localhost:15432/anchorpipe_dev"

# Encryption (required for HMAC secrets)
ENCRYPTION_KEY_BASE64="${encryptionKey}"

# Redis
REDIS_URL="redis://localhost:6379"

# RabbitMQ
RABBIT_URL="amqp://guest:guest@localhost:5672"

# MinIO (S3-compatible)
S3_ENDPOINT="http://localhost:9000"
S3_ACCESS_KEY="minioadmin"
S3_SECRET_KEY="minioadminpassword"
S3_BUCKET="anchorpipe-dev"

# Application
NEXTAUTH_SECRET="${crypto.randomBytes(32).toString('base64')}"
NEXTAUTH_URL="http://localhost:3000"

# Email (console output for local testing)
EMAIL_PROVIDER="console"
EMAIL_FROM="noreply@localhost"

# SIEM (optional, for testing)
SIEM_ENABLED="false"
`;

// Atomically write .env.local with backup to reduce TOCTOU risk
if (fs.existsSync(envPath)) {
  const backupPath = envPath + `.backup.${Date.now()}`;
  console.log(`⚠️  .env.local already exists. Backing up to ${path.basename(backupPath)}`);
  fs.renameSync(envPath, backupPath);
}
fs.writeFileSync(tempPath, envContent, { mode: 0o600 });
fs.renameSync(tempPath, envPath);

console.log('✅ Local environment file created: .env.local');
console.log('');
console.log('Next steps:');
console.log('  1. Review .env.local and adjust if needed');
console.log('  2. Start services: docker-compose -f infra/docker-compose.yml up -d');
console.log('  3. Run migrations: npm run db:migrate');
console.log('  4. Create test repo: node scripts/create-test-repo.js');









