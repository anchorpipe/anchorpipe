name: DCO Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  dco:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Verify DCO
        run: |
          set -e
          echo "Checking DCO sign-off for commits..."
          
          FAILED_COMMITS=""
          BASE_REF="${GITHUB_BASE_REF:-main}"
          
          echo "Base ref: $BASE_REF"
          echo "Checking commits from origin/$BASE_REF to HEAD..."
          
          # Get list of commits, excluding merge commits (commits with more than one parent)
          for commit in $(git rev-list --no-merges origin/$BASE_REF..HEAD); do
            echo "Checking commit: $commit"
            COMMIT_MSG=$(git log -1 --format="%B" "$commit")
            SUBJECT=$(git log -1 --format='%s' "$commit")
            
            if echo "$COMMIT_MSG" | grep -q "^Signed-off-by:"; then
              echo "✅ Commit $commit ($SUBJECT) has DCO sign-off"
            else
              echo "❌ Commit $commit ($SUBJECT) is missing DCO sign-off"
              FAILED_COMMITS="$FAILED_COMMITS $commit"
            fi
          done
          
          if [ -n "$FAILED_COMMITS" ]; then
            echo ""
            echo "❌ The following commits are missing DCO sign-off:"
            for commit in $FAILED_COMMITS; do
              SUBJECT=$(git log -1 --format='%s' "$commit")
              echo "  - $commit: $SUBJECT"
            done
            echo ""
            echo "Please sign off your commits using: git commit --amend -s"
            echo "See CONTRIBUTING.md for details."
            exit 1
          else
            echo ""
            echo "✅ All commits are properly signed off."
          fi
