name: Comment Vercel Preview URLs

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'apps/docs/**'
      - 'docs/**'
      - 'adr/**'
      - '.github/workflows/docs-deploy.yml'

jobs:
  comment-preview:
    name: Comment Preview URL
    runs-on: ubuntu-latest
    # Only run if Vercel secrets are configured (optional - for PR comments)
    if: |
      github.event_name == 'pull_request' &&
      (secrets.VERCEL_TOKEN != '' && secrets.VERCEL_PROJECT_ID != '')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Wait for Vercel deployment
        run: |
          echo "Waiting for Vercel to deploy (Vercel handles deployments automatically via GitHub integration)..."
          echo "This workflow will comment the preview URL once Vercel deployment is ready."
          sleep 30

      - name: Get Vercel preview URL
        id: get-preview-url
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID || '' }}
        run: |
          # Get the latest deployment for this PR from Vercel API
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Fetching deployment for PR #${PR_NUMBER} (SHA: ${PR_SHA})"

          # Build API URL
          if [ -n "$VERCEL_ORG_ID" ]; then
            API_URL="https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=preview&meta-githubPullRequestNumber=${PR_NUMBER}"
            AUTH_HEADER="Authorization: Bearer ${VERCEL_TOKEN}"
            ORG_HEADER="x-vercel-scope: ${VERCEL_ORG_ID}"
            RESPONSE=$(curl -s -H "$AUTH_HEADER" -H "$ORG_HEADER" "$API_URL" || echo "")
          else
            API_URL="https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=preview&meta-githubPullRequestNumber=${PR_NUMBER}"
            AUTH_HEADER="Authorization: Bearer ${VERCEL_TOKEN}"
            RESPONSE=$(curl -s -H "$AUTH_HEADER" "$API_URL" || echo "")
          fi

          # Extract preview URL from response
          PREVIEW_URL=$(echo "$RESPONSE" | grep -oE '"url":"https://[^"]+\.vercel\.app"' | head -1 | sed 's/"url":"//;s/"//' || echo "")

          if [ -z "$PREVIEW_URL" ]; then
            # Try alternative: get by git commit SHA
            if [ -n "$VERCEL_ORG_ID" ]; then
              API_URL="https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=preview&meta-githubCommitSha=${PR_SHA}"
              RESPONSE=$(curl -s -H "$AUTH_HEADER" -H "$ORG_HEADER" "$API_URL" || echo "")
            else
              API_URL="https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=preview&meta-githubCommitSha=${PR_SHA}"
              RESPONSE=$(curl -s -H "$AUTH_HEADER" "$API_URL" || echo "")
            fi
            PREVIEW_URL=$(echo "$RESPONSE" | grep -oE '"url":"https://[^"]+\.vercel\.app"' | head -1 | sed 's/"url":"//;s/"//' || echo "")
          fi

          if [ -n "$PREVIEW_URL" ]; then
            echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT
            echo "Found preview URL: $PREVIEW_URL"
          else
            echo "Could not find preview URL. Vercel may still be deploying."
            echo "preview-url=" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with preview URL
        if: steps.get-preview-url.outputs.preview-url != ''
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.get-preview-url.outputs.preview-url }}';

            // Check if comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“š Documentation Preview')
            );

            const comment = `## ðŸ“š Documentation Preview

            Your documentation changes have been deployed to Vercel!

            **Preview URL:** ${previewUrl}

            > This preview will be updated automatically when you push new commits to this PR.
            > 
            > Vercel handles deployments automatically via GitHub integration.

            ---
            *Preview deployed by [Vercel](https://vercel.com)*`;

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸ“š Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Vercel handles deployments automatically** via GitHub integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.get-preview-url.outputs.preview-url }}" ]; then
            echo "**Preview URL:** ${{ steps.get-preview-url.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A preview comment has been added to the PR." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Preview URL not found yet. Vercel may still be deploying." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the [Vercel dashboard](https://vercel.com/dashboard) for deployment status." >> $GITHUB_STEP_SUMMARY
          fi
